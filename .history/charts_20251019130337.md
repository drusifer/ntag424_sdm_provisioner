# ACR122U API Mermaid Diagrams

This document contains Mermaid-formatted sequence and packet diagrams for the messages and structures found in the ACR122U API documentation.

## Chapter 3: PICC Interface Description

### ATR Format for ISO 14443 Part 3 PICCs

This diagram shows the structure of the Answer to Reset (ATR) message for ISO 14443-3 tags.

```mermaid
packet-diagram
  type: "header"
  title: "ATR for ISO 14443 Part 3 PICCs"
  section {
    "Initial Header (3Bh)": 8;
    "T0": 8;
    "TD1": 8;
    "TD2": 8;
    "T1 (Category Indicator)": 8;
  }
  section {
    label: "Historical Bytes (N bytes)";
    "Tk (Application Identifier)": 16;
    "RID (A000000306h)": 40;
    "Standard (S)": 8;
    "Card Name (C0, C1)": 16;
    "RFU": 32;
  }
  section {
    "TCK (Checksum)": 8;
  }
  ```

### ATR Format for ISO 14443 Part 4 PICCs

This diagram shows the structure of the ATR for ISO 14443-4 tags.

```mermaid
packet-diagram
  type: "header"
  title: "ATR for ISO 14443 Part 4 PICCs"
  section {
    "Initial Header (3Bh)": 8;
    "T0": 8;
    "TD1": 8;
    "TD2": 8;
  }
  section {
    label: "Historical Bytes (from ATS/ATQB response)";
    "T1 .. Tk": "...";
  }
  section {
    "TCK (Checksum)": 8;
  }
```

## Chapter 4: PICC Commands for General Purposes

### Get Data Command (APDU)

This command is used to retrieve the Unique ID (UID) or Answer to Select (ATS) from a tag.

```mermaid
packet-diagram
  type: "header"
  title: "Get Data APDU"
  section {
    "Class (FFh)": 8;
    "INS (CAh)": 8;
    "P1 (00h=UID, 01h=ATS)": 8;
    "P2 (00h)": 8;
    "Le (Expected Length)": 8;
  }
```

### Get Data Response

This is the response structure containing the requested UID or ATS.

```mermaid

packet-diagram
  type: "header"
  title: "Get Data Response (UID)"
  section {
    "Data Out (UID)": "...";
    "SW1": 8;
    "SW2": 8;
  }
 ```

## Chapter 5: PICC Commands for MIFARE Classic

### Load Authentication Keys Command (APDU)

This command loads an authentication key into the reader's volatile memory.

```mermaid
packet-diagram
  type: "header"
  title: "Load Authentication Keys APDU"
  section {
    "Class (FFh)": 8;
    "INS (82h)": 8;
    "P1 (Key Structure)": 8;
    "P2 (Key Number)": 8;
    "Lc (06h)": 8;
  }
  section {
    label: "Data In";
    "Key": 48;
  }
```

### Authentication Command (APDU)

This command performs authentication with a MIFARE Classic card sector using a previously loaded key.

```mermaid
packet-diagram
  type: "header"
  title: "Authentication APDU"
  section {
    "Class (FFh)": 8;
    "INS (86h)": 8;
    "P1 (00h)": 8;
    "P2 (00h)": 8;
    "Lc (05h)": 8;
  }
  section {
    label: "Data In";
    "Version (01h)": 8;
    "00h": 8;
    "Block Number": 8;
    "Key Type (60h=A, 61h=B)": 8;
    "Key Number (00h-01h)": 8;
  }
```

### Read Binary Blocks Command (APDU)

This command reads data from a memory block after successful authentication.

```mermaid
packet-diagram
  type: "header"
  title: "Read Binary Blocks APDU"
  section {
    "Class (FFh)": 8;
    "INS (B0h)": 8;
    "P1 (00h)": 8;
    "P2 (Block Number)": 8;
    "Le (Bytes to Read)": 8;
  }
  ```

### Read Binary Blocks Response

```mermaid
packet-diagram
  type: "header"
  title: "Read Binary Blocks Response"
  section {
    "Data Out (N bytes)": "...";
    "SW1": 8;
    "SW2": 8;
  }
```

### Update Binary Blocks Command (APDU)

This command writes data to a memory block after successful authentication.

packet-diagram
  type: "header"
  title: "Update Binary Blocks APDU"
  section {
    "Class (FFh)": 8;
    "INS (D6h)": 8;
    "P1 (00h)": 8;
    "P2 (Block Number)": 8;
    "Lc (Bytes to Update)": 8;
  }
  section {
    "Data In (Block Data)": "...";
  }

## Chapter 6: Pseudo-APDU Commands

### Direct Transmit Command

This command sends a raw payload to a non-PC/SC tag.

packet-diagram
  type: "header"
  title: "Direct Transmit Command"
  section {
    "Class (FFh)": 8;
    "INS (00h)": 8;
    "P1 (00h)": 8;
    "P2 (00h)": 8;
    "Lc (Payload Length)": 8;
  }
  section {
    "Data In (Payload)": "...";
  }

### Bi-color LED and Buzzer Control Command

This command provides control over the reader's peripherals.

packet-diagram
  type: "header"
  title: "LED and Buzzer Control Command"
  section {
    "Class (FFh)": 8;
    "INS (00h)": 8;
    "P1 (40h)": 8;
    "P2 (LED State Control)": 8;
    "Lc (04h)": 8;
  }
  section {
    label: "Data In";
    "T1 Duration": 8;
    "T2 Duration": 8;
    "Repetitions": 8;
    "Link to Buzzer": 8;
  }

### P2: LED State Control Bitfield

This diagram shows the bit assignments for the `P2` byte in the LED/Buzzer control command.

packet-diagram
  type: "header"
  title: "P2: LED State Control Bitfield"
  section {
    label: "1 Byte";
    "b7 (Blink Green)": 1;
    "b6 (Blink Red)": 1;
    "b5 (Initial Blink Green)": 1;
    "b4 (Initial Blink Red)": 1;
    "b3 (Mask Green)": 1;
    "b2 (Mask Red)": 1;
    "b1 (Final Green)": 1;
    "b0 (Final Red)": 1;
  }

### Get Firmware Version Command

packet-diagram
  type: "header"
  title: "Get Firmware Version Command"
  section {
    "Class (FFh)": 8;
    "INS (00h)": 8;
    "P1 (48h)": 8;
    "P2 (00h)": 8;
    "Le (00h)": 8;
  }

### Set PICC Operating Parameter Command

This command configures how the reader polls for different card types.

packet-diagram
  type: "header"
  title: "Set PICC Operating Parameter Command"
  section {
    "Class (FFh)": 8;
    "INS (00h)": 8;
    "P1 (51h)": 8;
    "P2 (New Parameter)": 8;
    "Le (00h)": 8;
  }

### PICC Operating Parameter Bitfield

This diagram details the bit assignments for the PICC operating parameter.

packet-diagram
  type: "header"
  title: "PICC Operating Parameter Bitfield"
  section {
    label: "1 Byte";
    "b7 (Auto Polling)": 1;
    "b6 (Auto ATS Gen)": 1;
    "b5 (Polling Interval)": 1;
    "b4 (FeliCa 424K)": 1;
    "b3 (FeliCa 212K)": 1;
    "b2 (Topaz)": 1;
    "b1 (ISO 14443-B)": 1;
    "b0 (ISO 14443-A)": 1;
  }

## Chapter 7: Communication Flows

### Accessing a FeliCa Tag

This sequence diagram illustrates the process of reading from a FeliCa tag.

sequenceDiagram
  participant PC
  participant Reader
  participant FeliCa Tag

  PC->>Reader: Establish Connection
  note right of Reader: Reader returns FeliCa ATR
  Reader-->>PC: ATR: 3B 8F ... 8Ah

  PC->>Reader: Read Memory Block APDU
  Reader->>FeliCa Tag: FeliCa Read Command
  FeliCa Tag-->>Reader: FeliCa Read Response
  Reader-->>PC: Read Response + SW (90 00)

### Accessing a Topaz Tag (NFC Forum Type 1)

This sequence shows how to connect to, read from, and write to a Topaz tag.

sequenceDiagram
  participant PC
  participant Reader
  participant Topaz Tag

  PC->>Reader: Establish Connection
  note right of Reader: Reader returns Topaz ATR
  Reader-->>PC: ATR: 3B 8F ... 9Fh

  PC->>Reader: Read APDU (e.g., Read address 08h)
  Reader->>Topaz Tag: Native Read Command
  Topaz Tag-->>Reader: Native Read Response (e.g., 18h)
  Reader-->>PC: Response Data + SW (90 00)

  PC->>Reader: Write APDU (e.g., Update address 08h with FFh)
  Reader->>Topaz Tag: Native Write Command
  Topaz Tag-->>Reader: Native Write Response (e.g., FFh)
  Reader-->>PC: Response Data + SW (90 00)

## Appendix B & C: APDU Flow Diagrams

### APDU Flow for ISO 14443-Compliant Tags

This diagram shows the general command and response flow for standard ISO 14443 tags.

sequenceDiagram
  participant PC
  participant Reader
  participant Tag

  PC->>Reader: APDU Command (e.g., Get Challenge)
  note right of Reader: Reader wraps APDU in ISO 14443 Frame
  Reader->>Tag: Tag-specific Command Frame
  Tag-->>Reader: Tag-specific Response Frame
  note right of Reader: Unwraps response from frame
  Reader-->>PC: APDU Response + Status Word (SW1 SW2)

### APDU Flow for ISO 18092-Compliant Tags

This diagram illustrates how native commands for tags like Topaz are sent, either directly or wrapped in a Pseudo-APDU.

sequenceDiagram
  participant PC
  participant Reader
  participant Tag

  alt Direct Native Command
    PC->>Reader: Native Command (e.g., Read Memory [01 08])
  else Pseudo-APDU Wrapped Command
    PC->>Reader: Pseudo-APDU (Direct Transmit) + Native Command
  end

  note right of Reader: Reader wraps command in ISO 18092 Frame
  Reader->>Tag: Tag-specific Command Frame
  Tag-->>Reader: Tag-specific Response Frame
  note right of Reader: Unwraps response from frame

  alt Direct Native Response
    Reader-->>PC: Native Response + Status Word (SW1 SW2)
  else Pseudo-APDU Wrapped Response
    Reader-->>PC: Pseudo-APDU Response + Native Response + SW
  end
```
