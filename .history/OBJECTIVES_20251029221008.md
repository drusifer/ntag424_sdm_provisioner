# NTAG424 SDM Provisioner - Project Objectives

**TLDR;**: Building a game with physical coins containing NFC tags. Tags must serve URLs with cryptographic tokens that servers can verify. Currently blocked on Seritag tag authentication. End goal: Provision tags with SDM for authenticated URL delivery.

---

## Game Use Case

### Physical Coin + NFC Tag System
- **Physical Component**: Coin that users flip/tap with their phone
- **NFC Tag**: Embedded NTAG424 DNA chip that serves a URL
- **URL Format**: `https://game-server.com/tap?uid={UID}&c={COUNTER}&mac={TOKEN}`
- **Server Verification**: Server verifies the MAC token cryptographically to authenticate the tap

### Required Functionality
1. **Tag Provisioning**: Configure tags with SDM (Secure Dynamic Messaging)
2. **Dynamic URL Generation**: Tag automatically adds UID, counter, and MAC to URL on each tap
3. **Server-Side Verification**: Server can verify MAC using shared keys
4. **Replay Protection**: Counter prevents replay attacks

---

## Technical Requirements

### What Must Work
‚úÖ **Standard NXP NTAG424 DNA Tags (HW 4.2)**
- Can authenticate with factory keys
- Can provision SDM
- Can serve authenticated URLs

‚ö†Ô∏è **Seritag NTAG424 DNA Tags (HW 48.0)** ‚Üê **CURRENT BLOCKER**
- Cannot authenticate (Phase 2 fails)
- Cannot provision SDM
- Blocking game coin production if Seritag tags are required

### SDM Configuration Needed
- **SDM Enabled**: Dynamic URL enhancement active
- **UID Mirror**: Tag UID included in URL
- **Read Counter**: Scan count included in URL (replay protection)
- **MAC Authentication**: Cryptographic MAC token for server verification
- **Base URL**: Game server endpoint written to tag

---

## Current Status

### What's Complete
- ‚úÖ **NDEF Read/Write**: Works WITHOUT authentication on Seritag tags! (BREAKTHROUGH)
- ‚úÖ **Static URL Provisioning**: Production-ready solution for game coins
- ‚úÖ **Registry Key Fix**: EscapeCommandEnable enabled for ACR122U reader
- ‚úÖ **File Selection**: ISOSelectFile working (P1=0x02)
- ‚úÖ **ISO Commands**: ISOReadBinary/ISOUpdateBinary working (CLA=00)
- ‚úÖ **Phase 1 Authentication**: Works correctly (returns encrypted RndB)
- ‚úÖ **Protocol Verification**: All Phase 2 steps verified correct per NXP spec
- ‚úÖ **Mock HAL**: Complete and verified to match real hardware exactly
- ‚úÖ **Comprehensive Testing**: 15+ test scripts created and executed
- ‚úÖ **Deep Dive Analysis**: Byte-by-byte verification confirms implementation correct
- ‚úÖ SDM provisioning code (for standard tags)
- ‚úÖ Server-side verification examples (`examples/07_sun_server_verification.py`)
- ‚úÖ URL parsing and MAC verification
- ‚úÖ Key management system (UID-based key derivation)
- ‚úÖ NDEF URL writing

### What's Blocking
- ‚ö†Ô∏è **SUN Configuration**: Not yet tested - may still require authentication
  - NDEF read/write works without auth ‚úÖ
  - SUN configuration needs testing
  - If SUN requires auth, still need EV2 Phase 2 solution

### ‚úÖ BREAKTHROUGH: NDEF Works Without Authentication!
- **Finding**: Can read/write NDEF without EV2 authentication
- **Impact**: Game coins can be provisioned (NDEF URLs at minimum)
- **Status**: ‚úÖ Verified - 6/12 comprehensive tests passing
  
### Impact
- **If using Seritag tags**: Production blocked until authentication resolved
- **If using standard NXP tags**: Should work immediately
- **Mixed environment**: Need to support both tag types

---

## Investigation Goals (Aligned with Game Needs)

### Primary Goal: Get Tags Provisioned ‚úÖ
- **For Game**: Need tags serving authenticated URLs
- **Current State**: Seritag tags can't be provisioned due to authentication failure
- **Solution Options**:
  1. **Option A**: Fix Seritag authentication ‚Üí Provision Seritag tags
  2. **Option B**: Use standard NXP tags ‚Üí Skip Seritag investigation
  3. **Option C**: Support both ‚Üí Solve Seritag for flexibility

### Secondary Goal: Understanding Seritag Protocol
- **Value**: If Seritag tags are cheaper/more available, solving this enables cost savings
- **Value**: Broader market compatibility
- **Timeline**: Lower priority if standard tags work for MVP

---

## Key Questions to Answer

1. **Tag Sourcing**: Are Seritag tags required, or can we use standard NXP tags?
2. **Production Timeline**: What's the deadline? (affects prioritization)
3. **Tag Quantity**: How many coins need provisioning? (affects automation needs)
4. **Server Ready**: Is server-side verification implemented?
5. **Key Management**: How are keys distributed between tags and server?

---

## Success Criteria

### Minimum Viable Product (MVP)
- [ ] At least one tag type (NXP or Seritag) can be fully provisioned
- [ ] Tag serves URL with MAC token
- [ ] Server can verify MAC token
- [ ] Replay protection (counter) works

### Full Solution
- [ ] Both NXP and Seritag tags can be provisioned
- [ ] Automatic tag type detection
- [ ] Production-ready provisioning workflow
- [ ] Complete key management system
- [ ] Server verification integrated

---

## Next Steps (Prioritized by Game Needs)

### Immediate Priority: Test SUN Configuration & Real NDEF Provisioning üéØ
1. ‚úÖ **BREAKTHROUGH**: NDEF read/write works WITHOUT authentication!
2. ‚úÖ **File Selection**: Working (ISOSelectFile with P1=0x02)
3. ‚úÖ **Test Script Created**: `examples/seritag/comprehensive_ndef_test.py`
4. ‚úÖ **Mock HAL**: Complete and verified - matches real hardware exactly
5. ‚è≥ **Next**: Test SUN configuration (ConfigureSunSettings command)
6. ‚è≥ **Next**: Write real NDEF URL with game server endpoint
7. ‚è≥ **Next**: Verify NFC-compliant NDEF readable by phones

### If SUN Requires Authentication
1. ‚ö†Ô∏è **Continue Investigation**: Reverse-engineer Seritag Phase 2 protocol
2. ‚ö†Ô∏è **Command 0x51 Research**: Explore potential recovery/reset methods
3. ‚ö†Ô∏è **Alternative Authentication**: Try EV1 or other protocols

### Both Paths
1. ‚úÖ **Key Management**: Ensure UID-based key derivation works
2. ‚úÖ **Server Verification**: Confirm MAC verification logic matches tag output
3. ‚úÖ **Documentation**: Document provisioning process for production

---

**Last Updated**: Current session - Aligned with game coin use case  
**Priority**: Enable tag provisioning for game production  
**Blocker**: Seritag authentication (only if Seritag tags required)
