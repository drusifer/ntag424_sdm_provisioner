# Current Step: Deep Dive Phase 2 Authentication Investigation

**TLDR;**: Phase 2 consistently fails with SW=91AE (Wrong RndB') despite correct format. Need to investigate Phase 1 RndB extraction, decryption, and Phase 2 encryption more deeply. Registry key fixed, format validated, but RndB' calculation is wrong.

---

## Step Goal

Deep dive into Phase 2 authentication to identify why RndB' calculation fails on Seritag tags, even though:
- ✅ Phase 1 works (returns 16 bytes encrypted RndB)
- ✅ Standard left rotate (1 byte) is correct format (accepted by tag)
- ✅ Command format is correct (SW=91AE, not SW=911C)
- ❌ Phase 2 fails with SW=91AE (Wrong RndB')

---

## Context & Why This Step

### Previous Findings
- ✅ **Registry Key Fixed**: EscapeCommandEnable now set correctly
- ✅ **Format Validation Works**: Standard left rotate is accepted by Seritag
- ✅ **Static URL Works**: NDEF provisioning works without auth (workaround found)
- ✅ **Phase 1 Works**: Returns 16 bytes encrypted RndB
- ❌ **Phase 2 Fails**: SW=91AE (Wrong RndB') across all keys tested
- ❌ **Comprehensive Variations**: 15 combinations tested, all failed

### Current Situation
- Game coins can be provisioned with static URLs (workaround)
- SDM/SUN requires full authentication (Phase 2 must work for dynamic auth)
- Phase 2 consistently fails despite correct protocol format
- Need to identify the root cause of RndB' mismatch

### User Story
**As a game developer**, I want Phase 2 authentication to work on Seritag tags, so that I can configure SDM/SUN for dynamic authenticated URLs with counter and MAC tokens.

**Acceptance Criteria:**
- [ ] Phase 2 authentication succeeds (SW=9000)
- [ ] Session keys can be derived after Phase 2
- [ ] Can configure SDM/SUN after successful authentication
- [ ] Can provision tags with dynamic authenticated URLs

---

## Step Plan

### Phase 1: Detailed Phase 1 Analysis
1. **Inspect Phase 1 response byte-by-byte**
   - Verify exact response structure
   - Check if response includes extra bytes beyond RndB
   - Verify SW=91AF behavior (is it truly 16 bytes complete?)
   
2. **Test Phase 1 decryption variations**
   - Try different AES modes (ECB, CBC, CTR)
   - Try different key formats
   - Verify decryption produces valid random-looking data
   
3. **Verify RndB extraction**
   - Log exact bytes received
   - Verify decryption output
   - Check for any padding/encoding issues

### Phase 2: Detailed Phase 2 Analysis
1. **Inspect Phase 2 plaintext construction**
   - Log RndA generation (16 bytes random)
   - Log RndB extraction and rotation (byte-by-byte)
   - Verify plaintext: RndA || RndB' (32 bytes exactly)
   
2. **Test Phase 2 encryption variations**
   - Verify AES-ECB encryption (2 blocks of 16 bytes)
   - Check block alignment
   - Verify no padding issues
   
3. **Inspect Phase 2 APDU construction**
   - Verify exact byte sequence
   - Check Lc value (32 bytes)
   - Verify command format: 90 AF 00 00 20 [32 bytes] 00

### Phase 3: Alternative Investigations
1. **Check if Phase 1 response includes additional data**
   - Maybe we're missing part of the challenge?
   - Check for multi-frame responses
   - Verify complete transaction
   
2. **Test if Seritag uses different encryption key**
   - Maybe factory key is derived differently?
   - Check if key needs to be based on UID
   - Try tag-specific key derivation
   
3. **Investigate Seritag documentation**
   - Search for Seritag-specific protocol differences
   - Check for modified authentication flow
   - Look for custom key derivation methods

### Phase 4: Implementation Fixes
1. **If root cause identified**, implement fix
2. **Test with fresh tag** (avoid delay counter)
3. **Verify full authentication flow**
4. **Test SDM/SUN configuration** after successful auth

---

## Implementation Plan

### Acceptance Tests (TDD)

**Test 1: Phase 1 Response Byte Analysis**
```python
def test_phase1_response_bytes():
    """Inspect Phase 1 response byte-by-byte."""
    # Phase 1
    # Capture exact response (all bytes, SW)
    # Verify structure
    # Expected: Exactly 16 bytes encrypted RndB + SW=91AF
    pass
```

**Test 2: Phase 1 Decryption Verification**
```python
def test_phase1_decryption():
    """Test Phase 1 decryption with various methods."""
    # Try AES-ECB (current)
    # Try AES-CBC
    # Verify decrypted output is random-looking (valid RndB)
    # Expected: Decryption produces 16 random bytes
    pass
```

**Test 3: RndB Rotation Byte Analysis**
```python
def test_rndb_rotation_bytes():
    """Inspect RndB rotation byte-by-byte."""
    # Log original RndB
    # Log rotated RndB
    # Verify rotation: left by 1 byte
    # Expected: First byte moved to end correctly
    pass
```

**Test 4: Phase 2 Plaintext Verification**
```python
def test_phase2_plaintext():
    """Verify Phase 2 plaintext construction."""
    # Log RndA (16 bytes)
    # Log RndB' (16 bytes)
    # Log plaintext: RndA || RndB' (32 bytes)
    # Verify exactly 32 bytes, block-aligned
    # Expected: 32 bytes exactly, 2 AES blocks
    pass
```

**Test 5: Phase 2 Encryption Verification**
```python
def test_phase2_encryption():
    """Verify Phase 2 encryption format."""
    # Encrypt plaintext with AES-ECB
    # Verify 32 bytes output (2 blocks)
    # Verify encryption round-trip
    # Expected: 32 bytes encrypted data, matches spec
    pass
```

**Test 6: Phase 2 APDU Byte Analysis**
```python
def test_phase2_apdu_bytes():
    """Inspect Phase 2 APDU byte-by-byte."""
    # Log full APDU: 90 AF 00 00 20 [32 bytes] 00
    # Verify each byte
    # Expected: Matches spec exactly
    pass
```

---

## Progress Tracking

### Completed
- [x] Registry key issue identified and fixed
- [x] Comprehensive Phase 2 variations tested (all failed)
- [x] Confirmed format is correct (standard left rotate accepted)
- [x] Static URL NDEF provisioning verified (workaround found)
- [x] SUN/SDM requires full authentication confirmed
- [x] Acceptance tests for SUN/SDM completed

### In Progress
- [ ] Phase 1 response byte-by-byte analysis
- [ ] Phase 1 decryption verification
- [ ] Phase 2 plaintext/encryption analysis

### Pending
- [ ] Acceptance tests created for Phase 2 deep dive
- [ ] Root cause identified
- [ ] Fix implemented and tested
- [ ] Full authentication flow verified
- [ ] SDM/SUN configuration tested after successful auth

---

## Success Criteria

1. ✅ Phase 2 authentication succeeds (SW=9000)
2. ✅ Can derive session keys
3. ✅ Can configure SDM/SUN after authentication
4. ✅ Can provision tags with dynamic authenticated URLs

---

## Next Actions

1. Create detailed logging test for Phase 1 response analysis
2. Create detailed logging test for Phase 2 plaintext/encryption analysis
3. Test on fresh tag (avoid delay counter)
4. Compare byte-by-byte with NXP spec
5. Identify root cause of RndB' mismatch

---

**Status**: Starting Phase 2 deep dive investigation  
**Estimated Duration**: 2-3 hours  
**Blockers**: None (registry key fixed, fresh tag available)  
**Next Review**: After Phase 1/Phase 2 byte analysis complete
