#!/usr/bin/env python3
"""
Seritag Command 0x51 Exploitation Script

Based on analysis results:
- 91CA: Session/state error (new discovery!)
- 6A86: Incorrect parameters 
- 917E: Authentication error
- Command 0x51 is definitely real and has specific parameter requirements

Strategy:
1. Try 0x51 immediately after Phase 1 (before state changes)
2. Wait between attempts to avoid rate limiting
3. Systematically test parameter combinations
4. Look for any successful responses that might unlock recovery
"""

from ntag424_sdm_provisioner.hal import CardManager
from ntag424_sdm_provisioner.commands.sdm_commands import SelectPiccApplication, AuthenticateEV2First
from ntag424_sdm_provisioner.constants import FACTORY_KEY
from Crypto.Cipher import AES
import logging
import time
import secrets

logging.basicConfig(level=logging.INFO)
log = logging.getLogger(__name__)

def test_0x51_after_phase1():
    """Test command 0x51 immediately after successful Phase 1."""
    
    log.info("ðŸŽ¯ Testing 0x51 immediately after Phase 1...")
    
    try:
        with CardManager(0) as card:
            SelectPiccApplication().execute(card)
            
            # Get Phase 1 challenge
            cmd = AuthenticateEV2First(key_no=0)
            response = cmd.execute(card)
            encrypted_rndb = response.challenge
            
            log.info(f"âœ… Phase 1 success: {encrypted_rndb.hex()}")
            
            # Immediately try 0x51 with different approaches
            test_cases = [
                # Basic variations
                ("No params", [0x90, 0x51, 0x00, 0x00]),
                ("With Le=00", [0x90, 0x51, 0x00, 0x00, 0x00]),
                ("With Le=01", [0x90, 0x51, 0x00, 0x00, 0x01]),
                ("With Le=10", [0x90, 0x51, 0x00, 0x00, 0x10]),
                
                # Try including the challenge
                ("Challenge as data", [0x90, 0x51, 0x00, 0x00, 0x10] + list(encrypted_rndb)),
                ("Challenge + Le", [0x90, 0x51, 0x00, 0x00, 0x10] + list(encrypted_rndb) + [0x00]),
                
                # Different P1/P2 combinations  
                ("P1=01", [0x90, 0x51, 0x01, 0x00, 0x00]),
                ("P2=01", [0x90, 0x51, 0x00, 0x01, 0x00]),
                ("P1=P2=01", [0x90, 0x51, 0x01, 0x01, 0x00]),
                
                # Key number variations (like authentication)
                ("Key 0 format", [0x90, 0x51, 0x00, 0x00, 0x01, 0x00, 0x00]),
                ("Key 1 format", [0x90, 0x51, 0x00, 0x00, 0x01, 0x01, 0x00]),
                ("Key format with len", [0x90, 0x51, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00]),
                
                # Factory/diagnostic patterns
                ("Factory pattern 1", [0x90, 0x51, 0xFF, 0xFF, 0x00]),
                ("Factory pattern 2", [0x90, 0x51, 0xAA, 0x55, 0x00]),
                ("Seritag magic?", [0x90, 0x51, 0x53, 0x45, 0x00]),  # 'SE' for SEritag
            ]
            
            for name, apdu in test_cases:
                try:
                    log.info(f"  Trying {name}: {[hex(x) for x in apdu]}")
                    response_data, sw1, sw2 = card.send_apdu(apdu)
                    
                    status = f"{sw1:02X}{sw2:02X}"
                    if status not in ["91CA", "6A86", "917E", "91AE"]:
                        log.info(f"ðŸŽ‰ DIFFERENT RESPONSE: {name} = {status}")
                        if response_data:
                            log.info(f"   Response data: {bytes(response_data).hex()}")
                    else:
                        log.debug(f"    Standard response: {status}")
                        
                except Exception as e:
                    log.debug(f"    {name} exception: {e}")
                    
                # Small delay between attempts
                time.sleep(0.1)
                    
    except Exception as e:
        log.error(f"Phase 1 + 0x51 test failed: {e}")

def test_0x51_timing_variations():
    """Test 0x51 with different timing approaches."""
    
    log.info("â° Testing 0x51 timing variations...")
    
    timings = [0, 0.5, 1.0, 2.0, 5.0]  # seconds after Phase 1
    
    for delay in timings:
        try:
            log.info(f"Testing with {delay}s delay...")
            
            with CardManager(0) as card:
                SelectPiccApplication().execute(card)
                
                # Phase 1
                cmd = AuthenticateEV2First(key_no=0)
                response = cmd.execute(card)
                
                # Wait
                if delay > 0:
                    time.sleep(delay)
                
                # Try 0x51
                apdu = [0x90, 0x51, 0x00, 0x00, 0x00]
                response_data, sw1, sw2 = card.send_apdu(apdu)
                
                status = f"{sw1:02X}{sw2:02X}"
                log.info(f"  Delay {delay}s: {status}")
                
        except Exception as e:
            log.error(f"  Delay {delay}s failed: {e}")
            
        # Wait between card sessions to avoid rate limiting
        time.sleep(1)

def test_0x51_different_keys():
    """Test 0x51 after Phase 1 with different key numbers."""
    
    log.info("ðŸ”‘ Testing 0x51 with different key numbers...")
    
    for key_no in range(5):  # Keys 0-4
        try:
            log.info(f"Testing with key {key_no}...")
            
            with CardManager(0) as card:
                SelectPiccApplication().execute(card)
                
                # Phase 1 with different key
                cmd = AuthenticateEV2First(key_no=key_no)
                response = cmd.execute(card)
                
                log.info(f"  Key {key_no} Phase 1: SUCCESS")
                
                # Try 0x51
                apdu = [0x90, 0x51, 0x00, 0x00, 0x00]
                response_data, sw1, sw2 = card.send_apdu(apdu)
                
                status = f"{sw1:02X}{sw2:02X}"
                log.info(f"  Key {key_no} 0x51: {status}")
                
        except Exception as e:
            log.info(f"  Key {key_no} failed: {e}")
            
        time.sleep(0.5)  # Avoid rate limiting

def test_0x51_brute_force_params():
    """Brute force different parameter combinations for 0x51."""
    
    log.info("ðŸ’¥ Brute forcing 0x51 parameters...")
    
    # Focus on promising parameter ranges
    p1_values = [0x00, 0x01, 0x02, 0x10, 0x20, 0x50, 0x51, 0xFF]
    p2_values = [0x00, 0x01, 0x02, 0x10, 0x20, 0x50, 0x51, 0xFF]
    
    promising_responses = []
    
    for p1 in p1_values:
        for p2 in p2_values:
            try:
                with CardManager(0) as card:
                    SelectPiccApplication().execute(card)
                    
                    # Phase 1 first
                    cmd = AuthenticateEV2First(key_no=0)
                    response = cmd.execute(card)
                    
                    # Try 0x51 with these parameters
                    apdu = [0x90, 0x51, p1, p2, 0x00]
                    response_data, sw1, sw2 = card.send_apdu(apdu)
                    
                    status = f"{sw1:02X}{sw2:02X}"
                    
                    # Log anything that's not a standard error
                    if status not in ["91CA", "6A86", "917E", "91AE", "6D00", "911C"]:
                        result = f"P1={p1:02X} P2={p2:02X} -> {status}"
                        log.info(f"ðŸ” INTERESTING: {result}")
                        promising_responses.append((p1, p2, status, response_data))
                        
            except Exception as e:
                pass  # Continue brute force
                
            time.sleep(0.1)  # Small delay
    
    if promising_responses:
        log.info("ðŸŽ¯ Promising responses found:")
        for p1, p2, status, data in promising_responses:
            log.info(f"  P1={p1:02X} P2={p2:02X} -> {status}")
            if data:
                log.info(f"    Data: {bytes(data).hex()}")
    else:
        log.info("No unusual responses found in parameter brute force")

def test_command_sequence():
    """Test if 0x51 needs to be part of a command sequence."""
    
    log.info("ðŸ”„ Testing command sequences...")
    
    sequences = [
        # Try standard commands before 0x51
        ("GetVersion + 0x51", [0x60]),
        ("GetKeyVersion + 0x51", [0x64, 0x00]),  
        ("GetFileSettings + 0x51", [0xF5, 0x02]),
        
        # Try multiple 0x51 commands
        ("0x51 twice", [0x51, 0x00, 0x00, 0x00]),
        
        # Try 0x51 with different CLA
        ("CLA=80", None),  # Special case
        ("CLA=00", None),  # Special case
    ]
    
    for name, pre_commands in sequences:
        try:
            log.info(f"Testing sequence: {name}")
            
            with CardManager(0) as card:
                SelectPiccApplication().execute(card)
                
                # Phase 1 
                cmd = AuthenticateEV2First(key_no=0)
                response = cmd.execute(card)
                
                # Execute pre-commands if any
                if pre_commands:
                    for pre_cmd in [pre_commands]:  # Make it a list
                        try:
                            pre_apdu = [0x90] + pre_cmd + [0x00]
                            card.send_apdu(pre_apdu)
                        except:
                            pass  # Ignore failures
                
                # Now try 0x51
                if name == "CLA=80":
                    apdu = [0x80, 0x51, 0x00, 0x00, 0x00]
                elif name == "CLA=00":
                    apdu = [0x00, 0x51, 0x00, 0x00, 0x00]
                else:
                    apdu = [0x90, 0x51, 0x00, 0x00, 0x00]
                    
                response_data, sw1, sw2 = card.send_apdu(apdu)
                status = f"{sw1:02X}{sw2:02X}"
                
                if status not in ["91CA", "6A86", "917E", "91AE"]:
                    log.info(f"ðŸŽ¯ {name} gave different result: {status}")
                    if response_data:
                        log.info(f"   Data: {bytes(response_data).hex()}")
                        
        except Exception as e:
            log.debug(f"{name} failed: {e}")
            
        time.sleep(0.5)

def main():
    """Run comprehensive 0x51 exploitation attempts."""
    
    log.info("ðŸš€ Seritag Command 0x51 Exploitation")
    log.info("=" * 60)
    log.info("Based on analysis: 0x51 is a real command with specific requirements")
    log.info("Goal: Find the right parameters/timing to make 0x51 succeed")
    log.info("")
    
    # Test different approaches
    test_0x51_after_phase1()
    log.info("")
    
    test_0x51_timing_variations() 
    log.info("")
    
    test_0x51_different_keys()
    log.info("")
    
    test_command_sequence()
    log.info("")
    
    # Only run brute force if specifically requested (it's slow)
    import sys
    if "--brute-force" in sys.argv:
        test_0x51_brute_force_params()
        log.info("")
    
    log.info("ðŸŽ¯ CONCLUSIONS:")
    log.info("- Command 0x51 is definitely real Seritag functionality")
    log.info("- Different parameters give different error codes") 
    log.info("- There may be timing or state requirements")
    log.info("- If successful, 0x51 might unlock factory/recovery functions")
    log.info()
    log.info("ðŸ’¡ Next: Analyze any unusual responses and research Seritag docs")

if __name__ == "__main__":
    main()
