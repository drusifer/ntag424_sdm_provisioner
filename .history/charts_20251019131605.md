Provisioning an NTAG 424 DNA for authenticated URLs is a more advanced process that involves not just writing data, but also configuring the tag's security features. The ACR122U reader acts as the bridge to send these specific configuration commands.

Here is a sequence diagram that demonstrates the typical workflow for provisioning an NTAG 424 DNA tag to generate a secure URL with a CMAC (Card Message Authentication Code) for tamper evidence.

### NTAG 424 Provisioning Sequence Diagram

This diagram outlines the steps an application would take using the ACR122U reader to configure an NTAG 424 DNA tag for generating secure, authenticated URLs.

```mermaid
sequenceDiagram
    participant App as Application / PC
    participant Reader as ACR122U Reader
    participant Tag as NTAG 424 DNA

    App->>Reader: 1. Connect to Reader & Tag
    Reader->>Tag: Power On & Select
    Tag-->>Reader: Return ATR
    Reader-->>App: Tag Connected (ATR Received)

    App->>Reader: 2. Authenticate with Factory Keys
    note right of App: Gain initial access to configure the tag.
    Reader->>Tag: ISOAuthenticate (Default Keys)
    Tag-->>Reader: Authentication Success
    Reader-->>App: Success

    App->>Reader: 3. Change Keys to Secret Keys
    note right of App: Secure the tag from unauthorized changes.
    Reader->>Tag: ChangeKey Command (for AppKey0, AppKey1, etc.)
    Tag-->>Reader: Success
    Reader-->>App: Keys Changed Successfully

    App->>Reader: 4. Write NDEF URL Template
    note right of App: The URL contains placeholders for the UID and CMAC. e.g., https://domain.com/verify?uid={UID}&cmac={CMAC}
    Reader->>Tag: UpdateBinary / Write NDEF Command
    Tag-->>Reader: Success
    Reader-->>App: NDEF Write Complete

    App->>Reader: 5. Enable SUN (CMAC) Feature
    note right of App: This is the crucial step for URL authentication.
    Reader->>Tag: ChangeFileSettings (Enable UID Mirroring & CMAC)
    Tag-->>Reader: Success
    Reader-->>App: SUN Feature Enabled

    App->>Reader: 6. Disconnect
    Reader->>Tag: Release Tag
```

### Explanation of the Provisioning Steps:

1.  **Connect to Tag**: The application establishes a connection with the NTAG 424 DNA via the ACR122U reader.
2.  **Authenticate with Factory Keys**: To make any changes, the application must first authenticate using the tag's default, pre-set keys.
3.  **Change Keys**: For security, the default keys are immediately changed to new, secret keys known only to the provisioning application or system. This prevents unauthorized personnel from re-configuring the tag.
4.  **Write NDEF URL Template**: A URL is written to the tag's NDEF memory. This URL is a template that includes placeholders where the tag will automatically insert its unique ID (UID) and the security code (CMAC) when it is tapped.
5.  **Enable SUN Feature**: The application sends a command to the tag to activate its "Secure Unique NFC" (SUN) feature. This configures the tag to dynamically generate a CMAC based on its secret key and a tap counter each time it's read. It also enables the UID mirroring feature, which tells the tag to insert this data into the URL placeholders.

After these steps, when a user taps the provisioned tag with their phone, the NTAG 424 automatically generates the full URL with the unique UID and a fresh CMAC, which can then be verified by a server to prove the tag's authenticity.

# ACR122U API Mermaid Diagrams

This document contains Mermaid-formatted sequence and packet diagrams for the messages and structures found in the ACR122U API documentation.

## Chapter 3: PICC Interface Description

### ATR Format for ISO 14443 Part 3 PICCs

This diagram shows the structure of the Answer to Reset (ATR) message for ISO 14443-3 tags.

```mermaid
packet
title "ATR for ISO 14443 Part 3 PICCs"

0-7: "Initial Header (3Bh)"
8-15: "T0"
16-23: "TD1"
24-31: "TD2"
32-39: "T1 (Category Indicator)"
40-55: "Tk (Application Identifier)"
56-95: "RID (A000000306h)"
96-103: "Standard (S)"
104-119: "Card Name (C0, C1)"
120-151: "RFU"
152-159: "TCK (Checksum)"
```

### ATR Format for ISO 14443 Part 4 PICCs

This diagram shows the structure of the ATR for ISO 14443-4 tags.

```mermaid
packet
title "ATR for ISO 14443 Part 4 PICCs"

0-7: "Initial Header (3Bh)"
8-15: "T0"
16-23: "TD1"
24-31: "TD2"
32-39: "Historical Bytes (from ATS/ATQB response)"
40-47: "TCK (Checksum)"
```

## Chapter 4: PICC Commands for General Purposes

### Get Data Command (APDU)

This command is used to retrieve the Unique ID (UID) or Answer to Select (ATS) from a tag.

```mermaid
packet
  type: "header"
  title: "Get Data APDU"
  section {
    "Class (FFh)": 8;
    "INS (CAh)": 8;
    "P1 (00h=UID, 01h=ATS)": 8;
    "P2 (00h)": 8;
    "Le (Expected Length)": 8;
  }
```

### Get Data Response

This is the response structure containing the requested UID or ATS.

```mermaid

packet
  type: "header"
  title: "Get Data Response (UID)"
  section {
    "Data Out (UID)": "...";
    "SW1": 8;
    "SW2": 8;
  }
 ```

## Chapter 5: PICC Commands for MIFARE Classic

### Load Authentication Keys Command (APDU)

This command loads an authentication key into the reader's volatile memory.

```mermaid
packet
  type: "header"
  title: "Load Authentication Keys APDU"
  section {
    "Class (FFh)": 8;
    "INS (82h)": 8;
    "P1 (Key Structure)": 8;
    "P2 (Key Number)": 8;
    "Lc (06h)": 8;
  }
  section {
    label: "Data In";
    "Key": 48;
  }
```

### Authentication Command (APDU)

This command performs authentication with a MIFARE Classic card sector using a previously loaded key.

```mermaid
packet
  type: "header"
  title: "Authentication APDU"
  section {
    "Class (FFh)": 8;
    "INS (86h)": 8;
    "P1 (00h)": 8;
    "P2 (00h)": 8;
    "Lc (05h)": 8;
  }
  section {
    label: "Data In";
    "Version (01h)": 8;
    "00h": 8;
    "Block Number": 8;
    "Key Type (60h=A, 61h=B)": 8;
    "Key Number (00h-01h)": 8;
  }
```

### Read Binary Blocks Command (APDU)

This command reads data from a memory block after successful authentication.

```mermaid
packet
  type: "header"
  title: "Read Binary Blocks APDU"
  section {
    "Class (FFh)": 8;
    "INS (B0h)": 8;
    "P1 (00h)": 8;
    "P2 (Block Number)": 8;
    "Le (Bytes to Read)": 8;
  }
  ```

### Read Binary Blocks Response

```mermaid
packet
  type: "header"
  title: "Read Binary Blocks Response"
  section {
    "Data Out (N bytes)": "...";
    "SW1": 8;
    "SW2": 8;
  }
```

### Update Binary Blocks Command (APDU)

This command writes data to a memory block after successful authentication.

```mermaid
packet
  type: "header"
  title: "Update Binary Blocks APDU"
  section {
    "Class (FFh)": 8;
    "INS (D6h)": 8;
    "P1 (00h)": 8;
    "P2 (Block Number)": 8;
    "Lc (Bytes to Update)": 8;
  }
  section {
    "Data In (Block Data)": "...";
  }
```

## Chapter 6: Pseudo-APDU Commands

### Direct Transmit Command

This command sends a raw payload to a non-PC/SC tag.

```mermaid
packet
  type: "header"
  title: "Direct Transmit Command"
  section {
    "Class (FFh)": 8;
    "INS (00h)": 8;
    "P1 (00h)": 8;
    "P2 (00h)": 8;
    "Lc (Payload Length)": 8;
  }
  section {
    "Data In (Payload)": "...";
  }
```

### Bi-color LED and Buzzer Control Command

This command provides control over the reader's peripherals.

```mermaid
packet
  type: "header"
  title: "LED and Buzzer Control Command"
  section {
    "Class (FFh)": 8;
    "INS (00h)": 8;
    "P1 (40h)": 8;
    "P2 (LED State Control)": 8;
    "Lc (04h)": 8;
  }
  section {
    label: "Data In";
    "T1 Duration": 8;
    "T2 Duration": 8;
    "Repetitions": 8;
    "Link to Buzzer": 8;
  }
```

### P2: LED State Control Bitfield

This diagram shows the bit assignments for the `P2` byte in the LED/Buzzer control command.

```mermaid
packet
  type: "header"
  title: "P2: LED State Control Bitfield"
  section {
    label: "1 Byte";
    "b7 (Blink Green)": 1;
    "b6 (Blink Red)": 1;
    "b5 (Initial Blink Green)": 1;
    "b4 (Initial Blink Red)": 1;
    "b3 (Mask Green)": 1;
    "b2 (Mask Red)": 1;
    "b1 (Final Green)": 1;
    "b0 (Final Red)": 1;
  }
```

### Get Firmware Version Command

```mermaid
packet
  type: "header"
  title: "Get Firmware Version Command"
  section {
    "Class (FFh)": 8;
    "INS (00h)": 8;
    "P1 (48h)": 8;
    "P2 (00h)": 8;
    "Le (00h)": 8;
  }
```

### Set PICC Operating Parameter Command

This command configures how the reader polls for different card types.

```mermaid
packet
  type: "header"
  title: "Set PICC Operating Parameter Command"
  section {
    "Class (FFh)": 8;
    "INS (00h)": 8;
    "P1 (51h)": 8;
    "P2 (New Parameter)": 8;
    "Le (00h)": 8;
  }
```

### PICC Operating Parameter Bitfield

This diagram details the bit assignments for the PICC operating parameter.

```mermaid
packet
  type: "header"
  title: "PICC Operating Parameter Bitfield"
  section {
    label: "1 Byte";
    "b7 (Auto Polling)": 1;
    "b6 (Auto ATS Gen)": 1;
    "b5 (Polling Interval)": 1;
    "b4 (FeliCa 424K)": 1;
    "b3 (FeliCa 212K)": 1;
    "b2 (Topaz)": 1;
    "b1 (ISO 14443-B)": 1;
    "b0 (ISO 14443-A)": 1;
  }
```

## Chapter 7: Communication Flows

### Accessing a FeliCa Tag

This sequence diagram illustrates the process of reading from a FeliCa tag.

```mermaid
sequenceDiagram
  participant PC
  participant Reader
  participant FeliCa Tag

  PC->>Reader: Establish Connection
  note right of Reader: Reader returns FeliCa ATR
  Reader-->>PC: ATR: 3B 8F ... 8Ah

  PC->>Reader: Read Memory Block APDU
  Reader->>FeliCa Tag: FeliCa Read Command
  FeliCa Tag-->>Reader: FeliCa Read Response
  Reader-->>PC: Read Response + SW (90 00)
```

### Accessing a Topaz Tag (NFC Forum Type 1)

This sequence shows how to connect to, read from, and write to a Topaz tag.

```mermaid
sequenceDiagram
  participant PC
  participant Reader
  participant Topaz Tag

  PC->>Reader: Establish Connection
  note right of Reader: Reader returns Topaz ATR
  Reader-->>PC: ATR: 3B 8F ... 9Fh

  PC->>Reader: Read APDU (e.g., Read address 08h)
  Reader->>Topaz Tag: Native Read Command
  Topaz Tag-->>Reader: Native Read Response (e.g., 18h)
  Reader-->>PC: Response Data + SW (90 00)

  PC->>Reader: Write APDU (e.g., Update address 08h with FFh)
  Reader->>Topaz Tag: Native Write Command
  Topaz Tag-->>Reader: Native Write Response (e.g., FFh)
  Reader-->>PC: Response Data + SW (90 00)
```

## Appendix B & C: APDU Flow Diagrams

### APDU Flow for ISO 14443-Compliant Tags

This diagram shows the general command and response flow for standard ISO 14443 tags.

```mermaid
sequenceDiagram
  participant PC
  participant Reader
  participant Tag

  PC->>Reader: APDU Command (e.g., Get Challenge)
  note right of Reader: Reader wraps APDU in ISO 14443 Frame
  Reader->>Tag: Tag-specific Command Frame
  Tag-->>Reader: Tag-specific Response Frame
  note right of Reader: Unwraps response from frame
  Reader-->>PC: APDU Response + Status Word (SW1 SW2)
```

### APDU Flow for ISO 18092-Compliant Tags

This diagram illustrates how native commands for tags like Topaz are sent, either directly or wrapped in a Pseudo-APDU.

```mermaid
sequenceDiagram
  participant PC
  participant Reader
  participant Tag

  alt Direct Native Command
    PC->>Reader: Native Command (e.g., Read Memory [01 08])
  else Pseudo-APDU Wrapped Command
    PC->>Reader: Pseudo-APDU (Direct Transmit) + Native Command
  end

  note right of Reader: Reader wraps command in ISO 18092 Frame
  Reader->>Tag: Tag-specific Command Frame
  Tag-->>Reader: Tag-specific Response Frame
  note right of Reader: Unwraps response from frame

  alt Direct Native Response
    Reader-->>PC: Native Response + Status Word (SW1 SW2)
  else Pseudo-APDU Wrapped Response
    Reader-->>PC: Pseudo-APDU Response + Native Response + SW
  end
```

## NTAG424 DNA SDM Provisioning Flow

### Complete SDM Provisioning Sequence

This diagram shows the complete workflow for provisioning an NTAG424 DNA tag for Secure Dynamic Messaging.

```mermaid
sequenceDiagram
    participant Host as Provisioning Host
    participant Reader as NFC Reader
    participant Tag as NTAG424 Tag

    %% 1. Establish Communication
    Host->>Reader: Connect()
    Reader->>Tag: Power On / ATR
    Tag-->>Reader: ATR Response
    Reader-->>Host: Tag Detected

    %% 2. Get Tag Information
    Host->>Tag: GetVersion()
    Tag-->>Host: Version Info + UID

    %% 3. Authenticate (EV2)
    rect rgb(80,70,130)
    note over Host,Tag: Secure session established with factory keys
    Host->>Tag: AuthenticateEV2First [C-APDU]
    Tag-->>Host: Encrypted RndB + SW
    Host->>Tag: AuthenticateEV2Part2 (Enc. RndA, rotated RndB)
    Tag-->>Host: Encrypted RndA' + SW
    note over Host: Session keys derived (SesAuthMACKey, SesEncKey)
    end

    %% 4. Change Keys
    rect rgb(31,97,141)
    note over Host,Tag: Update all keys to unique values
    Host->>Tag: ChangeKey (PICC Master Key)
    Tag-->>Host: Success (SW=90 00)
    Host->>Tag: ChangeKey (File Data Read Key)
    Tag-->>Host: Success (SW=90 00)
    Host->>Tag: ChangeKey (SDM MAC Key)
    Tag-->>Host: Success (SW=90 00)
    end

    %% 5. Re-authenticate with new keys
    rect rgb(50,150,100)
    note over Host,Tag: Authenticate with new PICC Master Key
    Host->>Tag: AuthenticateEV2First (New Key)
    Tag-->>Host: Encrypted RndB + SW
    Host->>Tag: AuthenticateEV2Part2 (Enc. RndA, rotated RndB)
    Tag-->>Host: Encrypted RndA' + SW
    end

    %% 6. Configure SDM
    rect rgb(39,174,96)
    note over Host,Tag: Configure NDEF file for SDM
    Host->>Tag: ChangeFileSettings (SDM Config)
    Tag-->>Host: Success (SW=90 00)
    end

    %% 7. Write NDEF Message
    rect rgb(230,126,34)
    note over Host,Tag: Write SDM-enabled NDEF message
    Host->>Tag: WriteData (NDEF with placeholders)
    Tag-->>Host: Success (SW=90 00)
    end

    %% 8. SDM Tag ready
    note over Tag: Tag provisioned and SDM enabled
```

### NTAG424 EV2 Authentication Protocol

This diagram details the EV2 authentication handshake used by NTAG424 DNA.

```mermaid
sequenceDiagram
    participant Reader as NFC Reader
    participant Tag as NTAG424 Tag

    %% Phase 1: Challenge Request
    Reader->>Tag: AuthenticateEV2First
    note right of Reader
        C-APDU: 90 71 00 00 01 [KeyNo] 00
        KeyNo: 0x00-0x04
    end note
    Tag-->>Reader: Encrypted RndB + SW(91 AF)
    note left of Tag
        R-APDU: E(Kx, RndB) || 91 AF
        RndB: 16 random bytes
    end note

    %% Phase 2: Authentication Response
    Reader->>Tag: AuthenticateEV2Part2
    note right of Reader
        C-APDU: 90 AF 00 00 20 [E(Kx, RndA || rotl(RndB))] 00
        RndA: 16 random bytes generated by reader
        rotl(RndB): RndB rotated left by 1 byte
    end note
    Tag-->>Reader: Encrypted Response + SW(90 00)
    note left of Tag
        R-APDU: E(Kx, Ti || RndA' || PDcap || PCDcap) || 90 00
        Ti: Transaction Identifier
        RndA': RndA rotated by tag
    end note

    %% Session Key Derivation
    note over Reader
        Derive Session Keys:
        - SesAuthMACKey = CMAC(Kx, SV1 || 00...00)
        - SesEncKey = CMAC(Kx, SV2 || 00...00)
        Where:
        - SV1 = A5 5A 00 01 00 80 || RndA[0:2]
        - SV2 = 5A A5 00 01 00 80 || RndA[0:2]
    end note
```

### SDM Configuration Data Structure

This diagram shows the structure of the ChangeFileSettings command payload for SDM configuration.

```mermaid
packet
  type: "header"
  title: "ChangeFileSettings SDM Payload"
  section {
    "File Number": 8;
    "Communication Mode": 8;
    "Access Rights (2 bytes)": 16;
  }
  section {
    label: "SDM Configuration";
    "SDM Options": 8;
    "PICC Data Offset (3 bytes)": 24;
    "MAC Input Offset (3 bytes)": 24;
    "MAC Offset (3 bytes)": 24;
  }
  section {
    label: "Optional Fields";
    "Encrypted Data Offset (3 bytes)": 24;
    "Encrypted Data Length (3 bytes)": 24;
    "Read Counter Offset (3 bytes)": 24;
  }
```

### NDEF Message Structure with SDM Placeholders

This diagram shows how SDM placeholders are embedded in NDEF messages.

```mermaid
packet
  type: "header"
  title: "NDEF Message with SDM Placeholders"
  section {
    label: "NDEF TLV";
    "T (03h)": 8;
    "L (Length)": 8;
  }
  section {
    label: "NDEF Record";
    "Header (D1h)": 8;
    "Type Length (01h)": 8;
    "Payload Length": 8;
    "Type (55h = URI)": 8;
    "URI Prefix (04h = https://)": 8;
  }
  section {
    label: "URL with Placeholders";
    "Base URL": "...";
    "?uid=": "...";
    "{UID}": 14;
    "&c=": "...";
    "{CNT}": 8;
    "&mac=": "...";
    "{MAC}": 16;
  }
  section {
    "Terminator TLV (FEh)": 8;
  }
```
