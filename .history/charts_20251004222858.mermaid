sequenceDiagram
    participant Client as Python Script
    participant Reader as NFC Reader (HAL)
    participant Tag as NTAG424 Tag

    %% 1. Connection
    Client->>Reader: Connect()
    Reader->>Tag: Power On / ATR
    Tag-->>Reader: ATR Response
    Reader-->>Client: Connection Established

    %% 2. Authentication
    Box Lavender Authenticate with Factory Key (0x00...00)
        Client->>Tag: Send(AuthenticateEV2First)
        note right of Client
            C-APDU: AuthenticateEV2First
            CLA:90 INS:71 P1:00 P2:00
            Lc:01 Data:00 Le:11
        end note

        Tag-->>Client: R-APDU (Encrypted RndB + SW)
        note left of Tag
            R-APDU: Response
            Encrypted RndB (16B) + SW(91 AF)
        end note

        note over Client
            Decrypt RndB' to get RndB.
            Generate random RndA.
        end note

        Client->>Tag: Send(AuthenticateEV2Part2)
        note right of Client
            C-APDU: AuthenticateEV2Part2 (INS:AF)
            Lc:20 Data: E(Kx, RndA + rotl(RndB'))
            Le:01
        end note

        Tag-->>Client: R-APDU (Encrypted RndA + SW)
        note left of Tag
            R-APDU: Response
            Encrypted RndA (16B) + SW(91 00)
        end note

        note over Client
            Authentication successful.
            Derives session keys:
            - SesAuthMACKey
            - SesEncKey
        end note
    end

    %% 3. Change Key
    Box LightBlue Change PICC Master Key (Key 0)
        Client->>Tag: Send(Encrypted ChangeKey)
        note right of Client
            C-APDU: ChangeKey (Encrypted Payload)
            Unencrypted Payload:
            KeyNo(1B) | New^Old(16B) | CRC32(New)(4B)
        end note
        Tag-->>Client: R-APDU (SW = 91 00)
    end

    %% 4. Set File Settings
    Box LightGreen Configure NDEF File (File 2) for SDM
        Client->>Tag: Send(Encrypted SetFileSettings)
        note right of Client
            C-APDU: SetFileSettings (Encrypted)
            Unencrypted Payload:
            FileNo | Comms | Access | SDM Opts...
        end note
        Tag-->>Client: R-APDU (SW = 91 00)
    end

    %% 5. Write NDEF
    Box Orange Write NDEF Message
        Client->>Tag: Send(WriteData command)
        note right of Client
            C-APDU: WriteData (NDEF)
            Payload:
            FileNo | Offset(3B) | Len(3B) | Chunk
        end note
        Tag-->>Client: R-APDU (SW = 91 00)
    end